name: Azure Static Web Apps CI/CD

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    # ── checkout ───────────────────────────────────────────────
    - uses: actions/checkout@v3
      with:
        submodules: true
        lfs: false

    # ── node & dependencies ────────────────────────────────────
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install deps → build → export
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps
        npm run build
        npx next export -o out          # ⬅️ creates the static `out/` folder

    # ── OIDC token for SPA workflow ────────────────────────────
    - run: npm install @actions/core@1.6.0 @actions/http-client --legacy-peer-deps
      name: Install OIDC helper libs

    - name: Get ID token
      id: idtoken
      uses: actions/github-script@v6
      with:
        script: |
          const { getIDToken } = require('@actions/core');
          return await getIDToken();
        result-encoding: string

    # ── deploy ─────────────────────────────────────────────────
    - name: Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_CALM_OCEAN_080A5230F }}
        action: upload
        app_location: "/"        # repo root
        api_location: ""         # no API
        output_location: "out"   # ⬅️ folder we just exported
        skip_app_build: true
        github_id_token: ${{ steps.idtoken.outputs.result }}

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Close Pull Request
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_CALM_OCEAN_080A5230F }}
        action: close
